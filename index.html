<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>

<script>
const MODEL_URL = "https://teachablemachine.withgoogle.com/models/Otp8GlSUe/";
let model;

async function loadModel() {
  if (!model) {
    const modelURL = MODEL_URL + "model.json";
    const metadataURL = MODEL_URL + "metadata.json";
    model = await tmImage.load(modelURL, metadataURL);
  }
}

async function predictFromUrl(imageUrl) {
  await loadModel();
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.crossOrigin = "anonymous";
    img.src = imageUrl;

    img.onload = async () => {
      const predictions = await model.predict(img);

      const result = predictions.map(p => ({
        className: p.className,
        probability: Number(p.probability.toFixed(4))
      }));

      // Invia il messaggio a Thunkable
      window.postMessage(JSON.stringify(result), "*");

      resolve(result);
    };

    img.onerror = () => {
      const errorMsg = { error: "Errore caricamento immagine" };
      window.postMessage(JSON.stringify(errorMsg), "*");
      reject(errorMsg);
    };
  });
}

// Riceve messaggi da Thunkable
window.addEventListener("message", async (event) => {
  const imageUrl = event.data;
  if (imageUrl && imageUrl.startsWith("http")) {
    await predictFromUrl(imageUrl);
  }
});
</script>
