<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Teachable Machine Thunkable</title>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
<script src="https://thunkable.github.io/webviewer-extension/thunkableWebviewerExtension.js"></script>
</head>

<body>
<div id="status">Inizializzazione...</div>
<span id="messageDisplay"></span>
<img id="preview"   style="max-width:90%; border:2px solid #ccc;">
<script>
const BASE_URL = "https://teachablemachine.withgoogle.com/models/Otp8GlSUe/";
let model = null;

/* ===============================
   INIT MODELLO
================================ */
async function init() {
  try {
    model = await tmImage.load(
      BASE_URL + "model.json",
      BASE_URL + "metadata.json"
    );
    document.getElementById("status").innerText = "Modello pronto 19";
   // ThunkableWebviewerExtension.postMessage("PRONTO");
  } catch (e) {
//    ThunkableWebviewerExtension.postMessage("ERRORE_LOAD:" + e.message);
document.getElementById("status").innerText = "ERRORE_LOAD:" + e.message;
  }
}
init();
// when we get a message from the app, display it on the page
ThunkableWebviewerExtension.receiveMessage(function(message) {
  // Do something with your message
 
    document.getElementById("messageDisplay").innerText =message;
	 
 
	const imageUrl = message.replace(/^"(.*)"$/, '$1');
	const img = document.createElement("img");
	img.crossOrigin = "anonymous";
	img.src = imageUrl;
	 
	if(isValidUrl(img.src)) {
		 
		const img = document.createElement("img");
		img.crossOrigin = "anonymous";
		img.src = imageUrl;

		runPrediction(img);
	}
	 
	
	
});
 function isValidUrl(str) {
    try { new URL(str); return true; }
    catch(e){ return false; }
}
function sendToThunkable(message) {
    if (window.ReactNativeWebView && window.ReactNativeWebView.postMessage) {
        window.ReactNativeWebView.postMessage(message);
    } else {
        console.warn("ReactNativeWebView non disponibile. Messaggio:", message);
    }
}
async function runPrediction(imgElement) {
    try {
        // 1. Controllo se il modello esiste
        if (!model) {
            ThunkableWebviewerExtension.postMessage("ERRORE: Modello non caricato");
            return;
        }

        // 2. Esegui la predizione
        const predictions = await model.predict(imgElement);
        
        // 3. Ordina i risultati (dal più probabile al meno)
        predictions.sort((a, b) => b.probability - a.probability);
        const top = predictions[0];

        // 4. Prepara l'oggetto JSON
        const resultJSON = JSON.stringify({
            className: top.className,
            probability: Number(top.probability.toFixed(4))
        });

        // 5. Invia un SINGOLO messaggio a Thunkable
        // Non serve il setTimeout se la libreria è caricata correttamente
        ThunkableWebviewerExtension.postMessage(resultJSON);

    } catch (err) {
        // Invia l'errore specifico a Thunkable per il debug
        ThunkableWebviewerExtension.postMessage("ERRORE_PREDICT: " + err.message);
    }
}


</script>
</body>
</html>
