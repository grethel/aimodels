<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Teachable Machine Thunkable</title>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
</head>
<body>
<div id="status">Inizializzazione...</div>
<img id="image-to-predict" style="display:none;" crossorigin="anonymous">

<script>
const BASE_URL = "https://teachablemachine.withgoogle.com/models/Otp8GlSUe/";
let model;

// Invia messaggio a Thunkable
function sendToThunkable(msg){
    window.postMessage(msg, "*");
}

async function init(){
    try {
        const modelURL = BASE_URL + "model.json";
        const metadataURL = BASE_URL + "metadata.json";
        model = await tmImage.load(modelURL, metadataURL);
        document.getElementById("status").innerText = "Modello pronto!";
        sendToThunkable("PRONTO");
    } catch(e){
        document.getElementById("status").innerText = "Errore: " + e.message;
        sendToThunkable("ERRORE_LOAD:" + e.message);
    }
}

async function predict(imageUrl){
    const img = document.getElementById("image-to-predict");
    img.src = imageUrl;
	alert(imageUrl);
    img.onload = async function(){
        document.getElementById("status").innerText = "Analizzando...";
        try{
            const predictions = await model.predict(img);
            predictions.sort((a,b) => b.probability - a.probability);
            const top = predictions[0];
            const msg = JSON.stringify({
                className: top.className,
                probability: Number(top.probability.toFixed(4))
            });
            document.getElementById("status").innerText = "Risultato: " + msg;
            sendToThunkable(msg);
        }catch(err){
            sendToThunkable("ERRORE_PREDICT:" + err.message);
        }
    }

    img.onerror = function(){
        sendToThunkable("ERRORE_CARICAMENTO_IMMAGINE");
    }
}

// Ricezione URL da Thunkable
window.addEventListener("message", function(event){
    const msg = event.data;
    if(msg && typeof msg === "string"){
        // Controllo che sia una URL valida http o https
        if(msg.startsWith("http://") || msg.startsWith("https://")){
            predict(msg);
        } else {
            console.warn("Messaggio ignorato, non Ã¨ una URL:", msg);
        }
    }
});

init();
</script>
</body>
</html>
