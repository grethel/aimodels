<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Riconoscimento Rifiuti</title>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.21.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>

<style>
body {
    font-family: Arial, sans-serif;
    text-align: center;
    margin: 0;
    padding: 20px;
    background: #f4f6f8;
}

h3 { color:#2c3e50; }

#status { margin-top:10px; font-weight:bold; }

video {
    width: 100%;
    max-width: 400px;
    height: auto;
    border: 2px solid #ccc;
    border-radius: 8px;
    margin-top: 10px;
}

button {
    display: block;
    margin: 15px auto;
    padding: 15px 30px;
    font-size: 18px;
    border-radius: 8px;
    cursor: pointer;
    background-color: #2c3e50;
    color: white;
    border: none;
}

button:active { background-color: #1f2a38; }
</style>
</head>
<body>

<h3>‚ôªÔ∏è Analisi del rifiuto</h3>
<p id="status">Caricamento modello‚Ä¶</p>

<video id="webcam" autoplay playsinline></video>
<button id="snapBtn">üì∏ Scatta Foto</button>

<script>
// --- Thunkable WebViewer ---
var ThunkableWebviewerExtension = {
  postMessage: function(message) {
    if (window.ReactNativeWebView) window.ReactNativeWebView.postMessage(message);
    else window.parent.postMessage(message,'*');
  }
};

// --- Teachable Machine ---
const URL = "https://teachablemachine.withgoogle.com/models/HpVTR048r/";
let model = null;
let modelReady = false;
let busy = false;

// Carica modello
async function loadModel() {
    model = await tmImage.load(URL + "model.json", URL + "metadata.json");
    modelReady = true;
    document.getElementById("status").innerText = "Modello pronto ‚úîÔ∏è";
}
window.addEventListener("load", loadModel);

// --- Webcam setup ---
const video = document.getElementById("webcam");
let videoReady = false;

navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
  .then(stream => {
      video.srcObject = stream;
      video.play();
      video.addEventListener('loadeddata', () => {
          videoReady = true;
          document.getElementById("status").innerText = "Webcam pronta ‚úîÔ∏è";
      });
  })
  .catch(err => {
      document.getElementById("status").innerText = "Errore accesso webcam: " + err;
  });

// --- Scatta foto ---
function capturePhoto() {
    if (!videoReady) {
        alert("Attendere che la fotocamera sia pronta!");
        return;
    }

    if (!modelReady || busy) return;
    busy = true;
    document.getElementById("status").innerText = "Analisi in corso‚Ä¶";

    // Canvas invisibile per catturare l'immagine
    const canvas = document.createElement("canvas");
    canvas.width = video.offsetWidth;
    canvas.height = video.offsetHeight;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    const imageBase64 = canvas.toDataURL("image/png");
    predictFromThunkable(imageBase64);
}

// --- Predizione ---
async function predictFromThunkable(imageBase64) {
    const img = new Image();
    img.src = imageBase64;

    img.onload = async () => {
        try {
            const predictions = await model.predict(img);
            predictions.sort((a,b)=>b.probability-a.probability);
            const best = predictions[0];
            const percent = (best.probability*100).toFixed(1);
            const result = best.className + " (" + percent + "%)";

            ThunkableWebviewerExtension.postMessage(result);
            document.getElementById("status").innerText = result;
        } catch(err) {
            ThunkableWebviewerExtension.postMessage("Errore analisi");
            document.getElementById("status").innerText = "Errore: " + err;
        }
        busy = false;
    };

    img.onerror = () => {
        ThunkableWebviewerExtension.postMessage("Errore immagine");
        document.getElementById("status").innerText = "Errore caricamento immagine";
        busy = false;
    };
}

// --- Event listener bottone ---
const btn = document.getElementById("snapBtn");
btn.addEventListener("touchend", capturePhoto, {passive:false});
btn.addEventListener("click", capturePhoto);
</script>

</body>
</html>
