<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Teachable Machine Thunkable</title>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
<script src="https://thunkable.github.io/webviewer-extension/thunkableWebviewerExtension.js"></script>
</head>

<body>
<div id="status">Inizializzazione...</div>
<span id="messageDisplay"></span>

<script>
const BASE_URL = "https://teachablemachine.withgoogle.com/models/Otp8GlSUe/";
let model = null;

/* === INIT MODELLO === */
async function init() {
    const modelURL = BASE_URL + "model.json";
    const metadataURL = BASE_URL + "metadata.json";
    model = await tmImage.load(modelURL, metadataURL);
    document.getElementById("status").innerText = "Modello pronto";
}
init();

/* === COMUNICAZIONE CON THUNKABLE === */
ThunkableWebviewerExtension.receiveMessageWithReturnValue(
  async function(message, callback) {

    document.getElementById("messageDisplay").innerText =
      "Ricevuto URL: " + message;

    // controllo modello
    if (!model) {
      callback("ERRORE: modello non pronto");
      return;
    }

    // controllo URL
    if (typeof message !== "string" || !message.startsWith("http")) {
      callback("ERRORE: input non valido");
      return;
    }

    const img = new Image();
    img.crossOrigin = "anonymous";
    img.src = message;

    img.onload = async () => {
      try {
        const predictions = await model.predict(img);
        predictions.sort((a, b) => b.probability - a.probability);

        const top = predictions[0];

        const response = JSON.stringify({
          className: top.className,
          probability: Number(top.probability.toFixed(4))
        });

        callback(response); // âœ… SOLO QUI

      } catch (err) {
        callback("ERRORE_PREDICT: " + err.message);
      }
    };

    img.onerror = () => {
      callback("ERRORE_CARICAMENTO_IMMAGINE");
    };
});
</script>
</body>
</html>
