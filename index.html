<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teachable Machine Thunkable</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; }
        #status { color: #666; font-size: 0.9em; }
    </style>
</head>
<body>
    <h3>Analisi Immagine AI</h3>
    <div id="status">Caricamento modello...</div>
    <div id="label-container"></div>
    <img id="image-to-predict" style="display:none;" crossorigin="anonymous">
	<div id="debug-log" style="background: #eee; font-size: 10px; color: red;"></div>
    <script type="text/javascript">
	    function logStatus(msg) {
        // Scrive sulla pagina (visibile nel Web Viewer)
        document.getElementById("debug-log").innerHTML += "<br>" + msg;
        // Invia a Thunkable per vederlo in una Label dell'app
        if (window.ThunkableWebview) {
            window.ThunkableWebview.postMessage("DEBUG: " + msg);
        }
    }

	
        const URL = "https://teachablemachine.withgoogle.com/models/Otp8GlSUe/";
        let model, labelContainer, maxPredictions;

        // Inizializza il modello all'avvio
        async function init() {
            const modelURL = URL + "model.json";
            const metadataURL = URL + "metadata.json";
            alert("ciao");
            try {
                model = await tmImage.load(modelURL, metadataURL);
                maxPredictions = model.getTotalClasses();
                document.getElementById("status").innerText = "Modello Pronto. Invia un'immagine da Thunkable.";
                
                // Comunica a Thunkable che il sistema Ã¨ pronto
                if (window.ThunkableWebview) {
                    window.ThunkableWebview.postMessage("MODEL_READY");
                }
            } catch (e) {
                document.getElementById("status").innerText = "Errore caricamento: " + e;
            }
        }

        // Funzione per predire l'immagine ricevuta tramite URL
        async function predict(imageUrl) {
            document.getElementById("status").innerText = "Analisi in corso...";
            const imgElement = document.getElementById("image-to-predict");
            
            // Impostiamo l'URL dell'immagine
            imgElement.src = imageUrl;

            imgElement.onload = async function() {
                const prediction = await model.predict(imgElement);
                let results = [];
                
                // Pulizia contenitore etichette
                const labelContainer = document.getElementById("label-container");
                labelContainer.innerHTML = "";

                for (let i = 0; i < maxPredictions; i++) {
                    const prob = (prediction[i].probability * 100).toFixed(0);
                    const className = prediction[i].className;
                    
                    // Mostra a video (opzionale)
                    const div = document.createElement("div");
                    div.innerHTML = `${className}: ${prob}%`;
                    labelContainer.appendChild(div);

                    // Prepara dati per Thunkable
                    results.push({ name: className, confidence: prob });
                }

                // Invia i risultati a Thunkable come stringa JSON
                if (window.ThunkableWebview) {
                    window.ThunkableWebview.postMessage(JSON.stringify(results));
                }
                document.getElementById("status").innerText = "Analisi completata.";
            };
        }

        // Ascolta i messaggi in arrivo da Thunkable
        window.addEventListener('message', function(event) {
            // Assicurati che il messaggio sia una stringa (l'URL)
            if (event.data && typeof event.data === 'string') {
                if (event.data !== "undefined") {
                    predict(event.data);
                }
            }
        });

    // Esempio d'uso dentro init()
    async function init() {
        logStatus("Inizializzazione modello...");
        try {
            model = await tmImage.load(modelURL, metadataURL);
            logStatus("Modello caricato con successo!");
        } catch (e) {
            logStatus("ERRORE: " + e.message);
        }
    }
        // Avvio
        init();
 
 
</script>
</body>
</html>