<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>AI Riconoscimento Rifiuti</title>

<!-- Librerie -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.21.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>

<style>
body { font-family: Arial; text-align: center; padding: 20px; background:#f4f6f8; }
h3 { color:#2c3e50; }
#status { margin-top:10px; font-weight:bold; }
</style>
</head>
<body>

<h3>♻️ Analisi del rifiuto</h3>
<p id="status">Caricamento modello…</p>

<script>
// Thunkable WebViewer Extension
var ThunkableWebviewerExtension = {
  postMessage: function (message) {
    if (window.ReactNativeWebView) {
      window.ReactNativeWebView.postMessage(message);
    } else {
      window.parent.postMessage(message, '*');
    }
  },
  receiveMessage: function(fxn) {
    var callbackFunction = function(event) {
      if (typeof fxn === 'function') {
        fxn(event.data)
      }
    };
    document.addEventListener('message', callbackFunction, false);
    window.addEventListener('message', callbackFunction, false);
  }
};

// Teachable Machine
const URL = "https://teachablemachine.withgoogle.com/models/HpVTR048r/";
let model = null;
let modelReady = false;
let busy = false;

// Carica il modello
async function loadModel() {
    model = await tmImage.load(URL + "model.json", URL + "metadata.json");
    modelReady = true;
    document.getElementById("status").innerText = "Modello pronto ✔️";
}
window.addEventListener("load", loadModel);

// Funzione principale
async function predictFromThunkable(imageBase64) {
    if (!modelReady || busy) return;
    busy = true;
    document.getElementById("status").innerText = "Analisi in corso…";

    const img = new Image();
    img.src = imageBase64;

    img.onload = async () => {
        try {
            const predictions = await model.predict(img);
            predictions.sort((a,b)=>b.probability-a.probability);
            const best = predictions[0];
            const percent = (best.probability*100).toFixed(1);
            const result = best.className + " (" + percent + "%)";
            
            ThunkableWebviewerExtension.postMessage(result);
            document.getElementById("status").innerText = result;

        } catch (err) {
            ThunkableWebviewerExtension.postMessage("Errore analisi");
            document.getElementById("status").innerText = "Errore";
        }
        busy = false;
    };

    img.onerror = () => {
        ThunkableWebviewerExtension.postMessage("Errore immagine");
        busy = false;
    };
}

// Ricezione foto da Thunkable X
ThunkableWebviewerExtension.receiveMessage(function(message){
alert("ciao");
    if (typeof message === "string" && message.startsWith("data:image")) {
        predictFromThunkable(message);
    }
});
</script>

</body>
</html>
