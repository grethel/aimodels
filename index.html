<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Teachable Machine Thunkable</title>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
</head>
<body>
<div id="status">Inizializzazione...</div>
<img id="image-to-predict" style="display:none;" crossorigin="anonymous">

<script>
const BASE_URL = "https://teachablemachine.withgoogle.com/models/Otp8GlSUe/";
let model;

function sendToThunkable(message) {
    if (window.ReactNativeWebView && window.ReactNativeWebView.postMessage) {
        window.ReactNativeWebView.postMessage(message);
    } else {
        console.warn("ReactNativeWebView non disponibile. Messaggio:", message);
    }
}

async function init() {
    try {
        const modelURL = BASE_URL + "model.json";
        const metadataURL = BASE_URL + "metadata.json";
        model = await tmImage.load(modelURL, metadataURL);
        sendToThunkable("PRONTO");
    } catch(e) {
        sendToThunkable("ERRORE_LOAD:" + e.message);
    }
}

async function predict(imageUrl) {
    const img = document.createElement("img");
    img.crossOrigin = "anonymous";
    img.src = imageUrl;

    img.onload = async () => {
        try {
            const predictions = await model.predict(img);
            predictions.sort((a,b)=>b.probability-a.probability);
            const top = predictions[0];
            sendToThunkable(JSON.stringify({
                className: top.className,
                probability: Number(top.probability.toFixed(4))
            }));
        } catch(err){
            sendToThunkable("ERRORE_PREDICT:" + err.message);
        }
    }

    img.onerror = () => {
        sendToThunkable("ERRORE_CARICAMENTO_IMMAGINE");
    }
}

// Ricezione URL da Thunkable (solo se Ã¨ un URL valido)
function isValidUrl(str) {
    try { new URL(str); return true; }
    catch(e){ return false; }
}

window.addEventListener("message", (event)=>{
    const msg = event.data;
	  sendToThunkable(msg);
    if(msg && typeof msg === "string" && isValidUrl(msg)){
        predict(msg);
    } else {
        console.warn("Messaggio ignorato non URL:", msg);
    }
});

init();
</script>
</body>
</html>
